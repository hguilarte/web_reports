{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Reports</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <!-- ðŸ”¹ Dashboard Title (With Logout Button) -->
    <div class="container mt-4">
        <div class="p-4 rounded text-white d-flex justify-content-between align-items-center"
             style="background: linear-gradient(135deg, #61a5c2, #87c5dd);">
            <div>
                <h1 class="fw-bold mb-1 text-uppercase" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.6);">
                    Dashboard
                </h1>
                <p class="fs-6">Welcome, {{ request.user.username }}</p>
            </div>
            <!-- ðŸ”¹ Logout Button -->
            <form method="post" action="{% url 'logout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-light btn-sm fw-bold">Logout</button>
            </form>
        </div>
    </div>

    <!-- ðŸ”¹ Main Report Sections -->
    <div class="container mt-4">
        <div class="row">

            <!-- ðŸ”¹ Membership Reports -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <h5 class="card-title text-success">Membership Reports</h5>
                        <p class="card-text text-muted">Analyze membership trends.</p>

                        <!-- ðŸ”¹ Buttons -->
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <a href="{% url 'cap_pivot' %}" class="btn btn-outline-success">12 Months</a>
                            <a href="{% url 'cap_yearly' %}" class="btn btn-outline-primary">By Year</a>
                        </div>

                        <!-- ðŸ”¹ Graph Container -->
                        <div class="mt-3 p-3 border rounded bg-light">
                            <h6 class="text-muted fst-italic mb-2">Membership by Plans by Month</h6>

                            <div class="d-flex justify-content-between align-items-center">
                                <select id="membershipDateFilter" class="form-select form-select-sm" style="width: auto;"></select>
                            </div>

                            <div class="d-flex justify-content-center align-items-center position-relative mt-3" style="height: 250px;">
                                <canvas id="membershipChartCanvas" style="max-width: 100%; max-height: 100%;"></canvas>

                                <!-- ðŸ”¹ Centered Membership Count -->
                                <div class="position-absolute text-center" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                    <span id="totalMembership" class="fw-bold text-primary" style="font-size: 24px;">0</span>
                                    <div class="text-muted" style="font-size: 14px;">Members</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ðŸ”¹ Member Status Reports -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <h5 class="card-title text-primary">Member Status Reports</h5>
                        <p class="card-text text-muted">Monthly Enrollment Trends</p>

                        <!-- ðŸ”¹ Buttons -->
                        <div class="d-flex justify-content-center gap-2 mt-3">
                            <a href="{% url 'status_pivot' %}" class="btn btn-outline-primary">Enrollments</a>
                            <a href="{% url 'status_pivot_dis' %}" class="btn btn-outline-danger">Disenrollments</a>
                        </div>

                        <!-- ðŸ”¹ Graph Container -->
                        <div class="mt-3 p-3 border rounded bg-light">
                            <h6 class="text-muted fst-italic mb-2">Monthly Enrollment Trends</h6>
                            <canvas id="statusChartCanvas" style="max-width: 100%; height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ðŸ”¹ Financial Reports (Placeholder) -->
            <div class="col-md-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body text-center">
                        <h5 class="card-title text-danger">Financial Reports</h5>
                        <a href="#" class="btn btn-outline-danger">Coming Soon</a>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ðŸ”¹ Scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let membershipChart;
            let membershipData = {};
            let selectedDate = "";
            let availableDates = [];

            function initChart() {
                let canvasElement = document.getElementById("membershipChartCanvas");
                if (!canvasElement) return;

                let ctx = canvasElement.getContext("2d");
                if (membershipChart) membershipChart.destroy();

                membershipChart = new Chart(ctx, {
                    type: "doughnut",
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: "70%",
                        animation: { duration: 800 },
                        plugins: { tooltip: { callbacks: { label: (tooltipItem) => `${tooltipItem.label}: ${tooltipItem.raw} members` } }, legend: { display: false } }
                    }
                });

                updateChart();
            }

            function updateChart() {
                if (!selectedDate || !membershipData[selectedDate]) return;
                let data = membershipData[selectedDate];
                membershipChart.data.labels = Object.keys(data.plans);
                membershipChart.data.datasets[0].data = Object.values(data.plans);
                document.getElementById("totalMembership").textContent = data.total;
                membershipChart.update();
            }

            function loadMembershipData() {
                fetch("{% url 'membership_data' %}")
                    .then(response => response.json())
                    .then(data => {
                        membershipData = data;
                        availableDates = Object.keys(data);
                        if (availableDates.length > 0) {
                            selectedDate = availableDates[0];
                            updateFilterOptions();
                            initChart();
                        }
                    })
                    .catch(error => console.error("Error loading membership data:", error));
            }

            function updateFilterOptions() {
                let selectElement = document.getElementById("membershipDateFilter");
                selectElement.innerHTML = "";
                availableDates.forEach(date => {
                    let option = document.createElement("option");
                    option.value = date;
                    option.textContent = date;
                    selectElement.appendChild(option);
                });
                selectElement.value = selectedDate;
            }

            document.getElementById("membershipDateFilter").addEventListener("change", function () {
                selectedDate = this.value;
                updateChart();
            });

            loadMembershipData();
        });
    </script>

</body>
</html>
