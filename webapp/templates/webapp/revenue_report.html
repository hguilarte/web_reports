{% extends "webapp/base_report.html" %}
{% load custom_filters %}

{% block head_extra %}
<style>
.hidden-content {
    opacity: 0;
}
.content-loaded {
    opacity: 1;
    transition: opacity 0.1s;
}
/* --- Styles for Sorting (Re-added) --- */
.sortable-column {
    cursor: pointer;
    position: relative;
    white-space: nowrap;
}
.sortable-column:hover {
    background-color: rgba(44, 95, 124, 0.8) !important;
}
/* Add space for icons */
.sortable-column {
    padding-right: 20px !important;
}
.sortable-column::after {
    content: " \2195"; /* Up/Down arrow */
    font-size: 0.8em;
    opacity: 0.5;
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    line-height: 1;
}
.sortable-column.sorted-asc::after {
    content: " \2191"; /* Up arrow */
    opacity: 1;
}
.sortable-column.sorted-desc::after {
    content: " \2193"; /* Down arrow */
    opacity: 1;
}
</style>
{% endblock %}

{% block title %}Financial Reports{% endblock %}
{% block report_title %}Financial Reports - {% if selected_year == 'last_12' %}Last 12 Months{% else %}{{ selected_year }}{% endif %}{% endblock %}

{% block report_content %}
<div id="mainContent" class="hidden-content">

    {% include "webapp/partials/breadcrumb.html" with breadcrumb_items=breadcrumb_data %}

    <div class="container mt-2 mb-0 p-0">
        <div class="d-flex justify-content-between align-items-center px-3">
            <form method="GET" action="{% url 'revenue_report' %}" class="d-flex align-items-center gap-2" id="filterForm">
                <label for="year_select" class="me-2 mb-0 breadcrumb-label" style="color: #2c5f7c; white-space: nowrap;">
                    Select Period:
                </label>
                <select name="year" id="year_select" class="form-select form-select-sm w-auto">
                    <option value="last_12" {% if selected_year == 'last_12' %}selected{% endif %}>Last 12 Months</option>
                    {% for year in available_years %}
                        <option value="{{ year.year }}" {% if selected_year == year.year|stringformat:'s' %}selected{% endif %}>{{ year.year }}</option>
                    {% endfor %}
                </select>

                <input type="text" name="search" id="searchInput" value="{{ request.GET.search|default:'' }}" class="form-control form-control-sm" placeholder="Search members..." style="width: 200px;">
            </form>

            <a href="{% url 'export_revenue_excel' %}?year={{ selected_year|default:'last_12' }}&search={{ request.GET.search|urlencode|default:'' }}" class="custom-export-btn" id="exportButton">
                ðŸ“Š Export to Excel
            </a>
        </div>
    </div>

    <div class="container bg-white p-3 rounded shadow-sm mt-1">
        {% if pivot_list %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                 {% include "webapp/partials/pagination.html" with top_id="paginationTop" show_rows_selector=True show_counter=True counter_position="right" %}
            </div>

            <div class="table-responsive">
                <table class="table table-striped table-hover text-center align-middle" id="dataTable">
                    <thead class="custom-table-header sticky-top">
                        <tr>
                            {# --- Re-added sorting attributes --- #}
                            <th class="text-start px-2 sortable-column" data-column="-1">Member Name</th>
                            {% for capmo in capmo_labels %}
                                <th class="px-2 sortable-column" data-column="{{ forloop.counter0 }}">{{ capmo }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {# Content generated by Django initially, then managed by JS #}
                        {% for row in pivot_list %}
                        <tr>
                            <td class="text-start px-2">
                                <a href="{% url 'claim_detail' row.medicare_id 'MOS_HERE' %}?year={{ selected_year }}" class="member-link" title="View claims for {{ row.member }}">
                                    {{ row.member }}
                                </a>
                            </td>
                            {% for capmo in capmo_labels %}
                                {% with value=row|dict_get:capmo|default:0 %}
                                <td class="revenue-cell" data-member="{{ row.member }}" data-capmo="{{ capmo }}" data-value="{{ value }}">
                                    {% with claims_key=capmo|add:"_has_claims" %}
                                        {% if row|dict_get:claims_key %}
                                            <a href="{% url 'claim_detail' row.medicare_id capmo %}?year={{ selected_year }}" class="revenue-link" title="View {{ capmo }} claims for {{ row.member }}">
                                                <span class="{% if value > 0 %}text-success fw-bold{% elif value < 0 %}text-danger fw-bold{% endif %}">
                                                    {{ value|floatformat:2 }}
                                                </span>
                                            </a>
                                        {% else %}
                                            <span class="{% if value > 0 %}text-success{% elif value < 0 %}text-danger{% endif %}">
                                                {{ value|floatformat:2 }}
                                            </span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                {% endwith %}
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr class="table-secondary">
                            <td class="text-start px-2">Total</td>
                            {% for capmo in capmo_labels %}
                                <td class="revenue-cell text-end">
                                    {% with value=total_by_month|dict_get:capmo|default:"0" %}
                                        {% if value > 0 %}
                                            <span class="text-success">{{ value|floatformat:2 }}</span>
                                        {% elif value < 0 %}
                                            <span class="text-danger">{{ value|floatformat:2 }}</span>
                                        {% else %}
                                            <span>{{ value|floatformat:2 }}</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                            {% endfor %}
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
                 {% include "webapp/partials/pagination.html" with top_id="paginationBottom" show_rows_selector=True show_counter=True counter_position="right" %}
            </div>
        {% else %}
            <div class="alert alert-info text-center" role="alert">
                No data available for the selected period{% if request.GET.search %} matching "{{ request.GET.search }}"{% endif %}.
            </div>
        {% endif %}
    </div>
</div>

<script>
// Fade in content
window.addEventListener('DOMContentLoaded', function () {
    setTimeout(() => {
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.classList.add('content-loaded');
        }
    }, 10);
});

// --- Combined Script for Pagination, Sorting, Formatting, etc. ---
document.addEventListener("DOMContentLoaded", function () {

    const table = document.getElementById('dataTable');
    if (!table) return;

    const tbody = table.querySelector("tbody");
    if (!tbody) return;

    // --- Capture original rows BEFORE pagination script might modify tbody ---
    const originalRows = Array.from(tbody.querySelectorAll("tr"));
    // This array will hold the data *after* filtering and sorting by the *local* script
    let currentSortedAndFilteredRows = [...originalRows];
    let isManuallySorted = false; // Flag to track if manual sort is active

    let paginationInstance = null; // Variable to potentially hold the pagination instance

    // --- Initialize Reusable Pagination ---
    if (typeof window.initPagination === 'function') {
        if (originalRows.length > 0) {
            paginationInstance = window.initPagination({ // Store the instance if initPagination returns one
                tableId: 'dataTable',
                topPaginationId: 'paginationTop',
                bottomPaginationId: 'paginationBottom',
                rowCounterId: 'rowCounter',
                rowCounterTopId: 'rowCounterTop',
                rowsPerPageId: 'rowsPerPage',           // initPagination will handle this selector
                rowsPerPageBottomId: 'rowsPerPageBottom', // initPagination will handle this selector
                searchInputId: 'searchInput',
                initialRowsPerPage: 10 // Let initPagination read the default value
            });
             // Apply initial search filter to our separate array if needed
             const searchInputElem = document.getElementById('searchInput');
             if (searchInputElem && searchInputElem.value) {
                 const searchTerm = searchInputElem.value.toLowerCase().trim();
                 currentSortedAndFilteredRows = originalRows.filter(row => {
                    return Array.from(row.querySelectorAll('td')).some(cell =>
                        cell.textContent.toLowerCase().includes(searchTerm)
                    );
                 });
             }
        }
    } else {
        console.error("initPagination function not found.");
    }

    // --- Number Formatting Function ---
    function formatVisibleNumbers() {
        const numberCells = tbody.querySelectorAll('.revenue-cell span');
        numberCells.forEach(cell => {
            const text = cell.textContent.trim();
            if (text && text !== '-') {
                const value = parseFloat(text.replace(/[$,]/g, ''));
                if (!isNaN(value)) {
                    cell.textContent = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            }
        });
         const totalCells = table.querySelectorAll('tfoot .revenue-cell span');
         totalCells.forEach(cell => {
             const text = cell.textContent.trim();
             if (text && text !== '-') {
                 const value = parseFloat(text.replace(/[$,]/g, ''));
                 if (!isNaN(value)) {
                     cell.textContent = value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 }
             }
         });
    }

    // --- Initial formatting ---
     // Use a small delay to allow initPagination to potentially render the first page
    setTimeout(formatVisibleNumbers, 50);


    // --- Manual Display Function (Used AFTER local sorting) ---
    function displayManuallySortedPage(page = 1) {
        // âœ… Get the most current rowsPerPage value from either top or bottom select
        const rowsPerPageSelect = document.getElementById('rowsPerPage');
        const rowsPerPageBottomSelect = document.getElementById('rowsPerPageBottom');

        const currentRowsPerPage = rowsPerPageSelect?.value || rowsPerPageBottomSelect?.value || 10;
        const rowsPerPage = parseInt(currentRowsPerPage);

        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        tbody.innerHTML = "";
        currentSortedAndFilteredRows.slice(start, end).forEach(row => {
            tbody.appendChild(row.cloneNode(true));
        });

        formatVisibleNumbers();
    }

    // --- Sorting Logic ---
    document.querySelectorAll('th.sortable-column').forEach(header => {
        header.addEventListener('click', function() {
            isManuallySorted = true; // Activate manual sort mode

            const columnIndex = this.getAttribute('data-column') === '-1' ? 0 : parseInt(this.getAttribute('data-column')) + 1;
            const currentDirection = this.getAttribute('data-sort');
            const direction = currentDirection === 'asc' ? 'desc' : 'asc';

            // Update visual indicators
            document.querySelectorAll('th.sortable-column').forEach(col => {
                col.classList.remove('sorted-asc', 'sorted-desc');
                col.removeAttribute('data-sort');
            });
            this.classList.add(`sorted-${direction}`);
            this.setAttribute('data-sort', direction);

            // Filter original data based on current search term
            const searchInputElem = document.getElementById('searchInput');
            const searchTerm = searchInputElem ? searchInputElem.value.toLowerCase().trim() : '';
            let dataToSort = searchTerm ? originalRows.filter(row => { /* ... search logic ... */
                 return Array.from(row.querySelectorAll('td')).some(cell =>
                       cell.textContent.toLowerCase().includes(searchTerm)
                   );
            }) : [...originalRows];

            // Sort the filtered data
            dataToSort.sort((rowA, rowB) => {
                const cellA = rowA.querySelectorAll("td")[columnIndex];
                const cellB = rowB.querySelectorAll("td")[columnIndex];
                try {
                    if (columnIndex === 0) { // Member Name (text sort)
                        const a = cellA.textContent.trim().toLowerCase();
                        const b = cellB.textContent.trim().toLowerCase();
                        return direction === 'asc' ? a.localeCompare(b) : b.localeCompare(a);
                    } else { // Revenue columns (numeric sort)
                        let valA = parseFloat(cellA.getAttribute("data-value") || cellA.textContent.trim().replace(/[$,]/g, '')) || 0;
                        let valB = parseFloat(cellB.getAttribute("data-value") || cellB.textContent.trim().replace(/[$,]/g, '')) || 0;
                        valA = isNaN(valA) ? 0 : valA;
                        valB = isNaN(valB) ? 0 : valB;
                        return direction === 'asc' ? valA - valB : valB - valA;
                    }
                } catch (e) {
                    console.error("Error during sorting comparison:", e); return 0;
                }
            });

            // Update the array holding the current view state
            currentSortedAndFilteredRows = dataToSort;

            // Manually display the first page of the sorted data
            displayManuallySortedPage(1);
        });
    });

    // --- Listen for Search Input ---
    // Let initPagination handle the display update, but reset manual sort flag
    const searchInputElem = document.getElementById('searchInput');
    if (searchInputElem) {
        searchInputElem.addEventListener('input', function() {
            isManuallySorted = false; // Search overrides manual sort display
             // Reset sort indicators visually as initPagination doesn't preserve sort
             document.querySelectorAll('th.sortable-column').forEach(col => {
                col.classList.remove('sorted-asc', 'sorted-desc');
                col.removeAttribute('data-sort');
             });
            // No need to update currentSortedAndFilteredRows here, sorting logic will re-filter next time
            // initPagination will update the view
        });
    }

    // --- Listen for Pagination Clicks (from initPagination's controls) ---
    // We need to reset the manual sort flag if user clicks a page number
    // This uses event delegation on the pagination containers
    function handlePaginationControlClick() {
        isManuallySorted = false; // Let initPagination take back full control
        // Reset sort indicators visually
        document.querySelectorAll('th.sortable-column').forEach(col => {
            col.classList.remove('sorted-asc', 'sorted-desc');
            col.removeAttribute('data-sort');
        });
    }
    const topPaginationContainer = document.getElementById('paginationTop');
    const bottomPaginationContainer = document.getElementById('paginationBottom');
    if(topPaginationContainer) topPaginationContainer.addEventListener('click', handlePaginationControlClick);
    if(bottomPaginationContainer) bottomPaginationContainer.addEventListener('click', handlePaginationControlClick);


    // --- Listen for Rows Per Page Change (from initPagination's controls) ---
    // Reset manual sort flag and visual indicators
    function handleRowsPerPageChangeByPagination() {
         isManuallySorted = false; // Let initPagination take full control
         // Reset sort indicators visually
         document.querySelectorAll('th.sortable-column').forEach(col => {
             col.classList.remove('sorted-asc', 'sorted-desc');
             col.removeAttribute('data-sort');
         });
         // initPagination handles the display update and state change for rowsPerPage
    }
    const rowsPerPageSelect = document.getElementById('rowsPerPage');
    const rowsPerPageBottomSelect = document.getElementById('rowsPerPageBottom');
    // IMPORTANT: These listeners are for reacting AFTER initPagination's listener fires.
    if(rowsPerPageSelect) rowsPerPageSelect.addEventListener('change', handleRowsPerPageChangeByPagination);
    if(rowsPerPageBottomSelect) rowsPerPageBottomSelect.addEventListener('change', handleRowsPerPageChangeByPagination);


    // --- Handle year select change ---
    const yearSelect = document.getElementById("year_select");
    if (yearSelect) {
        yearSelect.addEventListener("change", function() {
            const searchInput = document.getElementById('searchInput');
            const currentSearch = searchInput ? searchInput.value : '';
            const form = document.getElementById('filterForm');
            let searchField = form.querySelector('input[name="search"]');
            if (!searchField && currentSearch) {
                 searchField = document.createElement('input');
                 searchField.type = 'hidden'; searchField.name = 'search'; searchField.value = currentSearch;
                 form.appendChild(searchField);
            } else if (searchField) {
                 searchField.value = currentSearch;
            }
            form.submit();
        });
    }

    // --- Dynamic Export Button URL ---
    if (searchInputElem && exportButton && yearSelect) {
        const updateExportLink = () => {
            const baseUrl = "{% url 'export_revenue_excel' %}";
            const currentYear = yearSelect.value;
            const searchTerm = searchInputElem.value;
            exportButton.href = `${baseUrl}?year=${currentYear}&search=${encodeURIComponent(searchTerm)}`;
        };
        searchInputElem.addEventListener('input', updateExportLink);
        yearSelect.addEventListener('change', updateExportLink);
        updateExportLink(); // Set initial state
    }

    // --- Re-apply formatting if pagination causes redraw ---
    // Use MutationObserver to reformat numbers when tbody changes
    const observer = new MutationObserver(mutations => {
         // Only format if manual sort isn't currently controlling the display
         // Or maybe always format? Let's try always formatting.
         // if (!isManuallySorted) {
             let changed = false;
             for(let mutation of mutations) {
                 if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                      changed = true;
                      break;
                 }
             }
             if(changed) formatVisibleNumbers();
         // }
    });
    observer.observe(tbody, { childList: true });


});
</script>

<style>
    .table-responsive { overflow-x: auto; }
    .table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
    .table th, .table td { padding: 0.4rem; vertical-align: middle; white-space: nowrap; }
    .table th:first-child, .table td:first-child { min-width: 150px; text-align: left; font-size: 0.75rem; }
    .table th:not(:first-child), .table td:not(:first-child) { min-width: 110px; text-align: center; font-size: 0.85rem; }
    .table td.revenue-cell, .table tfoot td:not(:first-child) { text-align: right !important; }

    .custom-table-header th { background: #2c5f7c !important; color: white; font-weight: bold; font-size: 0.85rem; }
    .revenue-cell { cursor: pointer; padding: 0.4rem !important; }
    .revenue-cell:hover { background-color: rgba(44, 95, 124, 0.15) !important; transition: background 0.2s ease-in-out; }
    .revenue-link { display: block; text-align: right; color: inherit; text-decoration: none; }
    .revenue-link:hover { text-decoration: underline; }

    .custom-export-btn { display: inline-block; font-weight: 400; font-size: 0.875rem; padding: 0.25rem 0.5rem; color: #2c5f7c !important; border: 1px solid #ced4da; border-radius: 0.2rem; text-decoration: none; background-color: #fff; height: 31px; line-height: 1.5; }
    .custom-export-btn:hover { background-color: #2c5f7c !important; color: white !important; border-color: #2c5f7c !important; }

    .breadcrumb-label { white-space: nowrap; }
    .sticky-top { position: sticky; top: 0; z-index: 10; }
    .member-link { color: inherit; text-decoration: none; }
    .member-link:hover { text-decoration: underline; }

     /* --- Styles for Sorting (Re-added/Kept) --- */
    .sortable-column { cursor: pointer; position: relative; }
    .sortable-column:hover { background-color: rgba(44, 95, 124, 0.8) !important; }
    .sortable-column { padding-right: 20px !important; } /* Space for icon */
    .sortable-column::after { content: " \2195"; font-size: 0.8em; opacity: 0.5; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); line-height: 1; }
    .sortable-column.sorted-asc::after { content: " \2191"; opacity: 1; }
    .sortable-column.sorted-desc::after { content: " \2193"; opacity: 1; }

</style>
{% endblock report_content %}